// Copyright (C) 2017, 2018 Verizon, Inc. All rights reserved.
#include <string.h>

#include "ts_message.h"
#include "ts_platform.h"

int main() {

	TsStatus_t status;
	ts_status_set_level( TsStatusLevelDebug );

	ts_status_debug( "** create example message\n" );
	TsMessageRef_t message, sensor;
	ts_message_create( &message );
	ts_message_set_string( message, "id", "00000000-0000-0000-0000-000000000000" );
	ts_message_set_string( message, "kind", "ts.event" );
	ts_message_set_string( message, "action", "update" );
	ts_message_create_message( message, "fields", &sensor );
	ts_message_set_float( sensor, "temperature", 30.2 );
	ts_message_encode( message, TsEncoderDebug, NULL, 0 );

	// encode thingspace cbor
	ts_status_debug( "** encode TS-CBOR\n" );
	uint8_t buffer[2049]; // one extra byte for zero termination of string-centric encodings (e.g., json)
	size_t buffer_size = 2048;
	ts_message_encode( message, TsEncoderTsCbor, buffer, &buffer_size );
	ts_platform_printf( "** TS-CBOR result (%d), '", buffer_size );
	for( int i = 0; i < buffer_size; i++ ) {
		ts_platform_printf( "%02x ", buffer[ i ] );
	}
	ts_platform_printf( "'\n" );

	ts_status_debug( "** decode TS-CBOR example\n" );
	//uint8_t example[] = { 0xa4, 0x66, 0x61, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x68, 0x61, 0x63, 0x74, 0x69, 0x76, 0x61, 0x74, 0x65, 0x62, 0x69, 0x64, 0x50, 0x84, 0xd1, 0x0d, 0x1e, 0x39, 0xed, 0x64, 0x46, 0xe5, 0xf8, 0x96, 0x58, 0x86, 0x43, 0xa6, 0x2f, 0x64, 0x6b, 0x69, 0x6e, 0x64, 0x6a, 0x74, 0x73, 0x2e, 0x65, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x6d, 0x74, 0x72, 0x61, 0x6e, 0x73, 0x61, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x69, 0x64, 0x50, 0xe6, 0xc1, 0xa5, 0xfe, 0x27, 0x27, 0x42, 0x06, 0xb3, 0x8d, 0x93, 0x72, 0x11, 0x66, 0x3e, 0xb9 };
	//uint8_t example[] = { 0xA7, 0x06, 0xA1, 0x69, 0x4C, 0x6F, 0x6E, 0x67, 0x69, 0x74, 0x75, 0x64, 0x65, 0xF6, 0x01, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x50, 0x5F, 0x56, 0x18, 0xC8, 0x77, 0x50, 0x47, 0xE1, 0x8D, 0x56, 0x01, 0x2D, 0x32, 0x0D, 0x5D, 0xB0, 0x03, 0x02, 0x04, 0x60, 0x05, 0x05, 0x69, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x64, 0x6F, 0x6E, 0x60 };
	//uint8_t example[] = { 0xa7,0x03,0x71,0x74,0x73,0x2e,0x65,0x76,0x65,0x6e,0x74,0x2e,0x66,0x69,0x72,0x65,0x77,0x61,0x6c,0x6c,0x04,0x60,0x05,0x06,0x69,0x63,0x72,0x65,0x61,0x74,0x65,0x64,0x6f,0x6e,0x60,0x06,0xa1,0x6d,0x63,0x6f,0x6e,0x66,0x69,0x67,0x75,0x72,0x61,0x74,0x69,0x6f,0x6e,0xa1,0x66,0x65,0x6e,0x61,0x62,0x6c,0x65,0xf5,0x01,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x50,0x65,0xf1,0x79,0x2e,0xb6,0x73,0x69,0x1d,0xe9,0x2b,0xaa,0xd6,0x34,0x2b,0x6c,0x2c};
	//uint8_t example[] = { 0xa7,0x04,0x60,0x05,0x06,0x69,0x63,0x72,0x65,0x61,0x74,0x65,0x64,0x6f,0x6e,0x60,0x06,0xa2,0x65,0x72,0x75,0x6c,0x65,0x73,0x80,0x67,0x64,0x6f,0x6d,0x61,0x69,0x6e,0x73,0x81,0x78,0x1b,0x74,0x68,0x69,0x6e,0x67,0x73,0x70,0x61,0x63,0x65,0x2d,0x63,0x6f,0x72,0x65,0x2e,0x76,0x65,0x72,0x69,0x7a,0x6f,0x6e,0x2e,0x63,0x6f,0x6d,0x01,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x50,0x25,0xb1,0x62,0x1f,0x37,0xf2,0x67,0xee,0xf1,0xa2,0x90,0x52,0x21,0xd5,0x3f,0x95,0x03,0x71,0x74,0x73,0x2e,0x65,0x76,0x65,0x6e,0x74,0x2e,0x66,0x69,0x72,0x65,0x77,0x61,0x6c,0x6c };
	//uint8_t example[] = { 0xa7,0x04,0x60,0x05,0x06,0x69,0x63,0x72,0x65,0x61,0x74,0x65,0x64,0x6f,0x6e,0x60,0x06,0xa1,0x67,0x64,0x6f,0x6d,0x61,0x69,0x6e,0x73,0x81,0x78,0x1b,0x74,0x68,0x69,0x6e,0x67,0x73,0x70,0x61,0x63,0x65,0x2d,0x63,0x6f,0x72,0x65,0x2e,0x76,0x65,0x72,0x69,0x7a,0x6f,0x6e,0x2e,0x63,0x6f,0x6d,0x01,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x50,0x25,0xb1,0x62,0x1f,0x37,0xf2,0x67,0xee,0xf1,0xa2,0x90,0x52,0x21,0xd5,0x3f,0x95,0x03,0x71,0x74,0x73,0x2e,0x65,0x76,0x65,0x6e,0x74,0x2e,0x66,0x69,0x72,0x65,0x77,0x61,0x6c,0x6c };
	//uint8_t example[] ={0xa7,0x02,0x50,0x45,0x01,0xea,0x90,0xe4,0x92,0x6a,0x25,0xe0,0xcd,0x21,0x3a,0xa3,0x37,0x8a,0x66,0x03,0x71,0x74,0x73,0x2e,0x65,0x76,0x65,0x6e,0x74,0x2e,0x66,0x69,0x72,0x65,0x77,0x61,0x6c,0x6c,0x04,0x60,0x05,0x06,0x69,0x63,0x72,0x65,0x61,0x74,0x65,0x64,0x6f,0x6e,0x60,0x06,0xa2,0x67,0x64,0x6f,0x6d,0x61,0x69,0x6e,0x73,0x81,0x6e,0x74,0x73,0x2e,0x76,0x65,0x72,0x69,0x7a,0x6f,0x6e,0x2e,0x63,0x6f,0x6d,0x65,0x72,0x75,0x6c,0x65,0x73,0x80,0x01,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	uint8_t example[] ={0xa7,0x02,0x50,0x25,0x51,0xc6,0x70,0xaa,0xf9,0x69,0xe0,0xfe,0xd6,0xd7,0x88,0x91,0x87,0x76,0x31,0x03,0x71,0x74,0x73,0x2e,0x65,0x76,0x65,0x6e,0x74,0x2e,0x66,0x69,0x72,0x65,0x77,0x61,0x6c,0x6c,0x04,0x60,0x05,0x06,0x69,0x63,0x72,0x65,0x61,0x74,0x65,0x64,0x6f,0x6e,0x60,0x06,0xa1,0x6d,0x63,0x6f,0x6e,0x66,0x69,0x67,0x75,0x72,0x61,0x74,0x69,0x6f,0x6e,0xa3,0x6f,0x64,0x65,0x66,0x61,0x75,0x6c,0x74,0x5f,0x64,0x6f,0x6d,0x61,0x69,0x6e,0x73,0x81,0x78,0x1b,0x74,0x68,0x69,0x6e,0x67,0x73,0x70,0x61,0x63,0x65,0x2d,0x63,0x6f,0x72,0x65,0x2e,0x76,0x65,0x72,0x69,0x7a,0x6f,0x6e,0x2e,0x63,0x6f,0x6d,0x6d,0x64,0x65,0x66,0x61,0x75,0x6c,0x74,0x5f,0x72,0x75,0x6c,0x65,0x73,0x83,0xa6,0x66,0x61,0x63,0x74,0x69,0x6f,0x6e,0x66,0x61,0x63,0x63,0x65,0x70,0x74,0x6b,0x64,0x65,0x73,0x74,0x69,0x6e,0x61,0x74,0x69,0x6f,0x6e,0xa0,0x65,0x6d,0x61,0x74,0x63,0x68,0x66,0x73,0x6f,0x75,0x72,0x63,0x65,0x68,0x70,0x72,0x6f,0x74,0x6f,0x63,0x6f,0x6c,0x63,0x74,0x63,0x70,0x65,0x73,0x65,0x6e,0x73,0x65,0x67,0x69,0x6e,0x62,0x6f,0x75,0x6e,0x64,0x66,0x73,0x6f,0x75,0x72,0x63,0x65,0xa3,0x67,0x6e,0x65,0x74,0x6d,0x61,0x73,0x6b,0x6f,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x64,0x70,0x6f,0x72,0x74,0xfb,0x40,0xc1,0x59,0x80,0x00,0x00,0x00,0x00,0x67,0x61,0x64,0x64,0x72,0x65,0x73,0x73,0x6f,0x31,0x39,0x38,0x2e,0x31,0x35,0x39,0x2e,0x31,0x39,0x36,0x2e,0x32,0x30,0x35,0xa6,0x66,0x73,0x6f,0x75,0x72,0x63,0x65,0xa0,0x66,0x61,0x63,0x74,0x69,0x6f,0x6e,0x66,0x61,0x63,0x63,0x65,0x70,0x74,0x6b,0x64,0x65,0x73,0x74,0x69,0x6e,0x61,0x74,0x69,0x6f,0x6e,0xa3,0x67,0x61,0x64,0x64,0x72,0x65,0x73,0x73,0x6f,0x31,0x39,0x38,0x2e,0x31,0x35,0x39,0x2e,0x31,0x39,0x36,0x2e,0x32,0x30,0x35,0x67,0x6e,0x65,0x74,0x6d,0x61,0x73,0x6b,0x6f,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x2e,0x32,0x35,0x35,0x64,0x70,0x6f,0x72,0x74,0xfb,0x40,0xc1,0x59,0x80,0x00,0x00,0x00,0x00,0x65,0x6d,0x61,0x74,0x63,0x68,0x6b,0x64,0x65,0x73,0x74,0x69,0x6e,0x61,0x74,0x69,0x6f,0x6e,0x68,0x70,0x72,0x6f,0x74,0x6f,0x63,0x6f,0x6c,0x63,0x74,0x63,0x70,0x65,0x73,0x65,0x6e,0x73,0x65,0x68,0x6f,0x75,0x74,0x62,0x6f,0x75,0x6e,0x64,0xa3,0x66,0x61,0x63,0x74,0x69,0x6f,0x6e,0x64,0x64,0x72,0x6f,0x70,0x6b,0x64,0x65,0x73,0x74,0x69,0x6e,0x61,0x74,0x69,0x6f,0x6e,0xa0,0x66,0x73,0x6f,0x75,0x72,0x63,0x65,0xa0,0x66,0x65,0x6e,0x61,0x62,0x6c,0x65,0xf5,0x01,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	TsMessageRef_t ex;
	ts_message_create( &ex );
	ts_message_decode( ex, TsEncoderTsCbor, example, sizeof(example) );
	ts_message_encode( ex, TsEncoderDebug, NULL, 0 );

	buffer_size = 2048;
	ts_message_encode( ex, TsEncoderTsCbor, buffer, &buffer_size );
	ts_platform_printf( "** CBOR result (%d), '", buffer_size );
	for( int i = 0; i < buffer_size; i++ ) {
		ts_platform_printf( "%02x ", buffer[ i ] );
	}
	ts_platform_printf( "'\n" );
	ts_message_destroy( ex );

	// dump cbor encoding
	ts_status_debug( "** decode TS-CBOR\n" );
	TsMessageRef_t test;
	ts_message_create( &test );
	ts_message_decode( test, TsEncoderTsCbor, buffer, buffer_size );
	ts_message_encode( test, TsEncoderDebug, NULL, 0 );
	ts_message_destroy( test );

	// encode plain-ole cbor
	ts_status_debug( "** encode CBOR\n" );
	buffer_size = 2048;
	ts_message_encode( message, TsEncoderCbor, buffer, &buffer_size );
	ts_platform_printf( "** CBOR result (%d), '", buffer_size );
	for( int i = 0; i < buffer_size; i++ ) {
		ts_platform_printf( "%02x ", buffer[ i ] );
	}
	ts_platform_printf( "'\n" );

	// dump cbor encoding
	ts_status_debug( "** decode CBOR\n" );
	ts_message_create( &test );
	ts_message_decode( test, TsEncoderCbor, buffer, buffer_size );
	ts_message_encode( test, TsEncoderDebug, NULL, 0 );
	ts_message_destroy( test );

	// encode json
	ts_status_debug( "** encode JSON\n" );
	buffer_size = 2048;
	ts_message_encode( message, TsEncoderJson, buffer, &buffer_size );
	buffer[ buffer_size ] = 0x00;
	ts_status_debug( "** JSON result (%d), '%s'\n", strlen((char *) buffer ), buffer );

	// dump json encoding
	ts_status_debug( "** decode json\n" );
	ts_message_create( &test );
	ts_message_decode( test, TsEncoderJson, buffer, buffer_size );
	ts_message_encode( test, TsEncoderDebug, NULL, 0 );

	// stop
	ts_message_destroy( message );
	ts_message_report();

	ts_status_debug( "** done.\n" );
}

